My modified version of the TMA code.